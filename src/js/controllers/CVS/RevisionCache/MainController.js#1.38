/* global messageRepository */

app.controller('MainCtrl',function($scope,$interval,$state,vertxEventBusService,$location,ngDialog,$timeout,$sce,$rootScope,$timeout,actionData,$stateParams){   
    //console.log("Entra en el controlador de angular...");
                 
        $scope.seePopup = function(popup,data){
              $scope.Error = "";
              $scope.data = data;
              
              if(popup==="DeleteRepo"){
                  $scope.data = sessionStorage.repoName;
                
                    console.log("data vale " + JSON.stringify($scope.data) + " el popup es " + popup);
                }
                else{
                    $scope.new_WORK_NAME = $scope.data.WORK_NAME;
                    $scope.new_WORK_DESCRIPTION = $scope.data.WORK_DESCRIPTION;
                    $scope.new_SNAPSHOT_DESCRIPTION = $scope.data.SNAPSHOT_DESCRIPTION;
                }

              
           ngDialog.open({ 
                template:'/templates/'+popup+'Template.html',
                controller: 'MainCtrl',
                scope: $scope,
                data: data
              });
      };
      //$scope.AddRepo.onClick($scope.seePopup );
if(sessionStorage.logado===undefined)
{
 $state.go("Login");
}

 $scope.changeClass=function(){
     
            $scope.clasesCss={
               pagewrapper:false,
               nopagewrapper:false
           };
           /* alert($scope.clasesCss.page-wrapper);
            alert(JSON.stringify($scope.clasesCss[0]));*/

            if($scope.logado===true){
               $scope.clasesCss.pagewrapper=true;
              $scope.clasesCss.nopagewrapper=false;
              }else if($scope.logado===false){
               $scope.clasesCss.nopagewrapper=true;
               $scope.clasesCss.pagewrapper=false;
              }
           
          $scope.classPadding={
              sipadding:false,
              nopadding:false
          };
            if($scope.logado===true){
                $scope.classPadding.sipadding=false;
                $scope.classPadding.nopadding=true;
            }else if($scope.logado===false){  
                 $scope.classPadding.nopadding=false; 
                 $scope.classPadding.sipadding=true;
            }
         
         
            $scope.classNegritaHome={
                negrita:false,
                nonegrita:false
            };
            
            $scope.classNegritaWorks={
                negrita:false,
                nonegrita:false
            };
            
            $scope.classNegritaReports={
                negrita:false,
                nonegrita:false
            };
            
          $scope.url=$location.url();  
            
           if($scope.url==="/home"){
                      $scope.classNegritaHome.negrita=true;
                      //$scope.classNegrita.nonegrita=false;
            }else{
                     // $scope.classNegrita.nonegrita=true;
                      $scope.classNegritaHome.negrita=false;  
                      
            }
            
            if($scope.url==="/works"){
                      $scope.classNegritaWorks.negrita=true;
                     // $scope.classNegrita.nonegrita=false;
            }else{
                     // $scope.classNegrita.nonegrita=true;
                      $scope.classNegritaWorks.negrita=false;  
                      
            }
            
            if($scope.url==="/works/Reports/"){
                      $scope.classNegritaReports.negrita=true;
                      //$scope.classNegrita.nonegrita=false;
            }else{
                      //$scope.classNegrita.nonegrita=true;
                      $scope.classNegritaReports.negrita=false;  
                      
            }
           
        };
        
        
        
   
      /* $scope.changeActive=function(){   
        $scope.url = $location.url();
   
           if($scope.url==="/home"){
                      $scope.activeHome=true;
                      $scope.activeWorks=false;
                      $scope.activeReports=false;
            }else{
                      $scope.activeHome=false;
            }
            
            if($scope.url==="/works"){
                      $scope.activeWorks=true;
                      $scope.activeHome=false;
                      $scope.activeReports=false;
            }else{
                      $scope.activeWorks=false;
            }
            
            if($scope.url==="/works/Reports/"){
                      $scope.activeReports=true;
                      $scope.activeHome=false;
                      $scope.activeWorks=false;
            }else{
                      $scope.activeReports=false;
                      
            }
       };*/
       
     init = function(){
        if($scope.connectionOK !== true){
            $scope.connectionOK = false;
        }
        
        
        
      // $scope.changeClass();
      
          // $scope.url=$location.url();
          
         
         // LOGADO
        if(sessionStorage.logado)
        {
                    /*     if(sessionStorage.idSesion){
                             //ENVIA LA PETICION PARA OBTENER TODOS LOS WORKS
                             vertxEventBusService.send('work_actions', {VERTX_ACTION: "select_all", ID_SES:sessionStorage.idSesion, ID_CON:  (actionData.setIdCon()).toString()});
                         }*/
            $scope.user = sessionStorage.user;
            $scope.repositorio = sessionStorage.repoName;
            $scope.idSesion = sessionStorage.idSesion;
            $scope.no_logado = false;
            $scope.logado = true;
           
        }
        else
        {
                //SI NO ESTA LOGADO
            sessionStorage.removeItem("user");
            sessionStorage.removeItem("logado");
            $scope.user ="";
            $scope.password="";
            $scope.no_logado = true;
            $scope.logado = false;
          
        }
         
          
         
            $scope.no_logado = true;
            $scope.info="Connecting with server...";
          $scope.changeClass();
          
            
            if (!$scope.$$phase && !$scope.$root.$$phase) {
                $scope.$digest();
            }    
         
         
         //FUCION CAMBIAREPO
                        $scope.cambiaRepo = function (selectedRepo){
                                 //alert("selectedrepo vale en cambiorepo " + JSON.stringify(selectedRepo));
                                  $scope.selectedRepo = null;
                                            $('#selectedRepo option').prop({selected: false});
                                       $.each($scope.repos, function(key,value) {

                                            if(selectedRepo ===null){
                                                //SELECTEDREPO ESTA VACIO
                                                if($scope.repos[key].DEFAULT_REPO === 'yes'){
                                                $scope.selectedRepo = $scope.repos[key];
                                                $scope.selectedRepoName = $scope.repos[key].CONNECTION_NAME;
                                                sessionStorage.repo = $scope.selectedRepo;
                                                sessionStorage.repoName = $scope.selectedRepoName;
                                                }
                                                 $('#selectedRepo option:contains(' + $scope.repos[key].CONNECTION_NAME + ')').prop({selected: true});
                                            }
                                            else if(selectedRepo !== null){
                                                 //SELECTEDREPO NO ESTA VACIO
                                                 $scope.repos[key].DEFAULT_REPO = "yes";
                                                if($scope.repos[key].CONNECTION_NAME === selectedRepo.CONNECTION_NAME){
                                                   
                                                    $('#selectedRepo option:contains(' + $scope.repos[key].CONNECTION_NAME + ')').prop({selected: true});
                                                   
                                                    $scope.selectedRepo = $scope.repos[key];
                                                    $scope.selectedRepoName = $scope.repos[key].CONNECTION_NAME;
                                                    sessionStorage.repo = $scope.selectedRepo;
                                                    sessionStorage.repoName = $scope.selectedRepoName;

                                                }
                                            }
                                            
                                            
                                       });
                                      // alert("al final del each selectedrepo vale " + JSON.stringify($scope.selectedRepo)); 
                            };
                            
                            
                    // REPOSITORY RESULTS
                        vertxEventBusService.on('repository_results', function(messageRepository) {

                        if(Object.prototype.toString.call(messageRepository) === "[object Array]"){  
                            $scope.comprobacionError=messageRepository[0].VERTX_ERROR;
                          if(messageRepository[0].ACTION==="select_all"){             
                               $scope.repos=messageRepository;
                               $scope.repos.shift();  
                               $scope.cambiaRepo(null);                          
                           }else  if(messageRepository[0].ACTION==="delete_repo"){
                               setError(messageRepository[0].VERTX_ERROR,messageRepository[0].VERTX_MESSAGE,$scope,ngDialog,$timeout);
 
                           }else if(messageRepository[0].ACTION==="select_repo_data"){
                              $scope.datosRepo=messageRepository[1];

                           }else if(messageRepository[0].ACTION==="modify_repo" || messageRepository[0].ACTION==="create_repo_tables" || messageRepository[0].ACTION==="test_conn" || messageRepository[0].ACTION==="add_repo"){
                                setError(messageRepository[0].VERTX_ERROR,messageRepository[0].VERTX_MESSAGE,$scope,ngDialog,$timeout);
                               if(document.getElementById("DB_TYPE").value===""){
                                    $scope.error="Select a type  of database";
                                    $scope.message="Select a type  of database";
                                    setError($scope.error,$scope.message,$scope,ngDialog,$timeout);
                                }
                             }
                       }
                       
                       if(Object.prototype.toString.call(messageRepository) === "[object Object]"){
                           $scope.comprobacionError=messageRepository.VERTX_ERROR;
                            if(messageRepository.ACTION==="modify_repo"){ 
                                setError(messageRepository.VERTX_ERROR,messageRepository.VERTX_MESSAGE,$scope,ngDialog,$timeout);
                               
                                if(document.getElementById("DB_TYPE").value===""){
                                    $scope.error="Select a type  of database";
                                    $scope.message="Select a type  of database";
                                    setError($scope.error,$scope.message,$scope,ngDialog,$timeout);
                                }
                                
                            }else if(messageRepository.ACTION==="create_repo_tables"){
                                setError(messageRepository.VERTX_ERROR,messageRepository.VERTX_MESSAGE,$scope,ngDialog,$timeout);
                               
                                if(document.getElementById("DB_TYPE").value===""){
                                    $scope.error="Select a type  of database";
                                    $scope.message="Select a type  of database";
                                    setError($scope.error,$scope.message,$scope,ngDialog,$timeout);
                                }
                                
                                if(messageRepository.VERTX_ERROR==="NO"){
                                    $scope.createRepo=true;
                                }else{
                                    $scope.createRepo=false;
                                }
                            }else if(messageRepository.ACTION==="test_conn"){
                                setError(messageRepository.VERTX_ERROR,messageRepository.VERTX_MESSAGE,$scope,ngDialog,$timeout);
                               
                                if(document.getElementById("DB_TYPE").value===""){
                                    $scope.error="Select a type  of database";
                                    $scope.message="Select a type  of database";
                                    setError($scope.error,$scope.message,$scope,ngDialog,$timeout);
                                }
                                
                                if(messageRepository.VERTX_ERROR==="NO"){
                                    $scope.test=true;
                                }else{
                                    $scope.test=false;
                                }
                                
                            }else if(messageRepository.ACTION==="add_repo"){
                                setError(messageRepository.VERTX_ERROR,messageRepository.VERTX_MESSAGE,$scope,ngDialog,$timeout);
                               
                                if(document.getElementById("DB_TYPE").value===""){
                                    $scope.error="Select a type  of database";
                                    $scope.message="Select a type  of database";
                                    setError($scope.error,$scope.message,$scope,ngDialog,$timeout);
                                }
                            }
                            
                            
                        }

                           
                           if(Object.prototype.toString.call(messageRepository) === "[object Array]"){
                                if(messageRepository[0].ACTION==="select_repodb"){
                                    messageRepository.shift();
                                   $scope.dbType=[];
                                   
                                     for(var i=0; i<messageRepository.length; i++){
                                         $scope.dbType.push(messageRepository[i]);
                                     }                               
                               }
                               
                           }  
                        });
                            
                         if(sessionStorage.idSesion){
                             //ENVIA LA PETICION PARA OBTENER TODOS LOS WORKS
                             vertxEventBusService.send('work_actions', {VERTX_ACTION: "select_all", ID_SES:sessionStorage.idSesion, ID_CON:  (actionData.setIdCon()).toString()});
                         }
                     
                            //WORKS RESULTS
                             vertxEventBusService.on('work_results', function(messageWorks) {
                                 console.log(JSON.stringify(messageWorks));
                            // $scope.WorksResults = messageWorks; 
                               if(Object.prototype.toString.call(messageWorks) === "[object Object]"){
                                   console.log("es un object object");
                                    if(messageWorks.VERTX_ERROR && messageWorks.ID_SES===sessionStorage.idSesion && messageWorks.ID_CON===(actionData.getIdCon()).toString()){
                                       // alert("el error es " + messageWorks.VERTX_ERROR);
                                        $scope.info = messageWorks.VERTX_ERROR;
                                        if(messageWorks.VERTX_ERROR==="No works found"){
                                            $scope.noWorks = true;
                                        }
                                    }
                               }
                             
                             if(Object.prototype.toString.call(messageWorks) === "[object Array]"){
                                       if(messageWorks[0].ACTION ==="select_all"){
                                           $scope.WorksResults = messageWorks;
                                       }
                                    if(messageWorks[0].detailed === "yes"){
                                        console.log("si detail");
                                        $scope.DetailedWorks = messageWorks[1];
                                    }
                                     if(messageWorks[0].detailed === "no" && messageWorks[0].ID_SES===sessionStorage.idSesion && messageWorks[0].ID_CON===(actionData.getIdCon()).toString()){
                                        console.log("no detail");
                                      /*  
                                         if(messageWorks[0].ACTION ==="select_all"){
                                           $scope.WorksResults = messageWorks;
                                       }*/
                                       // $scope.WorksResults.shift();  
                                      //  alert("entra aqui y worksresults vale " + JSON.stringify($scope.WorksResults));
                                    if(messageWorks[0].ACTION ==="add" || messageWorks[0].ACTION ==="modify"  || messageWorks[0].ACTION ==="delete")
                                                    setError(messageWorks[0].VERTX_ERROR,messageWorks[0].VERTX_MESSAGE,$scope,ngDialog,$timeout);
                                              }
                                              
                                                if($scope.page==="Works" || $scope.page==="Home"){
                                                    $scope.generateTable(messageWorks);          
                                                }           

                                }             
                            });
                          
                            //BUS SNAPSHOT_RESULTS
                            vertxEventBusService.on('snapshot_results', function(messageSnapshots) {
                                 //CARGO LOS DETALLES DEL SNAPSHOT
                                    if(messageSnapshots[0].ACTION==="select_snapshot_detail" && messageSnapshots[0].ID_SES===sessionStorage.idSesion){ 
                                         $scope.snapshotDescription = messageSnapshots[1].SNAPSHOT_DESCRIPTION;
                                         $scope.snapshotCreated = messageSnapshots[1].CREATED;
                                         $scope.SelectedIdWork = messageSnapshots[1].ID_WORK;
                                         $scope.idSnapshot = messageSnapshots[1].ID_SNAPSHOT;
                                         
                                         
                                         if(messageSnapshots[0].detailed==="yes"){
                                                  //DETALLES DE LA EJECUCION DE LOS SNAPSHOTS
                                                  if(messageSnapshots[0].ACTION==="select_snapdet"){
                                                         if(messageSnapshots[0].VERTX_MESSAGE !=="No executions details for this snapshot"){
                                                            //HAY DETALLES DE LA EJECUCION
                                                              $scope.HaveSnapshotsExecutionDetails = true;
                                                              //DETAILEDSNAPSHOT ES LA VARIABLE CON LA QUE LEE LOS DATOS PARA GENERAR LA TABLA
                                                              $scope.ExecutionDetailedSnapshot = messageSnapshots;
                                                              //GENERO LA TABLA CON LOS DETALLES DE LA EJECUCIÓN DE LOS SNAPSHOTS
                                                              $scope.generateTable(messageSnapshots);
                                                        }

                                                        else{
                                                            //NO HAY DETALLES DE LA EJECUCION
                                                            $scope.info = messageSnapshots[0].VERTX_MESSAGE;
                                                            $scope.HaveSnapshotsExecutionDetails = false;
                                                        }  
                                                  }



                                                }

                                            }


                                if(messageSnapshots[0].detailed==="no"  && messageSnapshots[0].ID_SES===sessionStorage.idSesion && messageSnapshots[0].ID_CON===(actionData.getIdCon()).toString()){
                                     //SNAPSHOTS RESULTS
                                     
                                     if(messageSnapshots[0].ACTION==="select_all"){
                                                if(messageSnapshots[0].VERTX_MESSAGE ==="No snapshots for this work")
                                                {
                                                     //NO HAY SNAPSHOTS
                                                    $scope.HaveSnapshots = false;                                                         
                                                    $scope.info = messageSnapshots[0].VERTX_MESSAGE;
                                                }  
                                                else{
                                                    //SI HAY SNAPSHOT
                                                    $scope.info = "";
                                                    $scope.HaveSnapshots = true;  
                                                    $scope.SnapshotsResults = messageSnapshots;
                                                    $scope.SnapshotsResults.shift();
                                                    $scope.generateTable(messageSnapshots);
                                                    $scope.$broadcast('SnapshotsResults', {SnapshotsResults: messageSnapshots}); 
                                                }
                                     }
                                     //ACTIONS SNAPSHOT
                                    if(messageSnapshots[0].ACTION ==="add" || messageSnapshots[0].ACTION ==="modify"  || messageSnapshots[0].ACTION ==="delete")
                                    {
                                         //ENVIO LOS DATOS A LA FUNCION SETERROR, QUE SE ENCARGA DE MOSTRAR EL MENSAJE EN EL POPUP Y POSTERIORMENTE CERRARLO. SE ENCUENTRA EN FUNCTION.JS
                                         setError(messageSnapshots[0].VERTX_ERROR,messageSnapshots[0].VERTX_MESSAGE,$scope,ngDialog,$timeout);       
                                         //REFRESCO LOS DATOS DE LOS SNAPSHOTS PARA QUE APAREZCAN REFLEJADOS LOS CAMBIOS
                                         vertxEventBusService.send('snapshot_actions', {VERTX_ACTION: 'select_all', ID_WORK: sessionStorage.SelectedIdWork, ID_SES:sessionStorage.idSesion, ID_CON:  actionData.setIdCon().toString()});
                                    } 
                                }       
                                 
                                 
                                 if(messageSnapshots[0].ACTION==="select_snapparams"  && messageSnapshots[0].ID_SES===sessionStorage.idSesion){

                                          //SI NO HAY PARAMETROS DE LA BASE DE DATOS
                                          if(messageSnapshots[0].VERTX_MESSAGE ==="No parameters for this snapshot"){
                                           
                                              $scope.params = false;
                                              $scope.HaveParameters = false;
                                              $scope.infoParameters = messageSnapshots[0].VERTX_MESSAGE;
                                          }
                                          //SI SI HAY PARAMETROS DE LA BASE DE DATOS
                                          if(messageSnapshots[0].VERTX_MESSAGE ==="OK"){
                                              $scope.infoParameters = "Loading parameters...";
                                               $scope.HaveParameters = true;
                                               $scope.generateTable(messageSnapshots);
                                               $scope.params = messageSnapshots;
                                               $scope.params.shift();
                                          }

                                      }
                                      
                                      if(messageSnapshots[0].ACTION==="select_snapdet" ){
                                             if(messageSnapshots[0].VERTX_MESSAGE !=="No executions details for this snapshot"){
                                                //HAY DETALLES DE LA EJECUCION
                                                  $scope.HaveSnapshotsExecutionDetails = true;
                                                  //DETAILEDSNAPSHOT ES LA VARIABLE CON LA QUE LEE LOS DATOS PARA GENERAR LA TABLA
                                                  $scope.ExecutionDetailedSnapshot = messageSnapshots;
                                                  //GENERO LA TABLA CON LOS DETALLES DE LA EJECUCIÓN DE LOS SNAPSHOTS
                                                  $scope.generateTable(messageSnapshots);
                                            }
                                            
                                            else{
                                                //NO HAY DETALLES DE LA EJECUCION
                                                $scope.info = messageSnapshots[0].VERTX_MESSAGE;
                                                $scope.HaveSnapshotsExecutionDetails = false;
                                            }  
                                      }

                            });
                               //BUS QUERY_RESULTS
                            vertxEventBusService.on('query_results', function(messageQuerys) {
                               
                                        if(messageQuerys[0].ACTION==="select_bg_list" && messageQuerys[0].ID_SES===sessionStorage.idSesion){
                                            $scope.bgList = messageQuerys;
                                            $scope.bgList.shift();
                                            $scope.generateTable($scope.bgList);
                                        } 
                                        
                                if(messageQuerys[0].detailed==="no"  && messageQuerys[0].ID_SES===sessionStorage.idSesion && messageQuerys[0].ID_CON===(actionData.getIdCon()).toString()){
                                        if(messageQuerys[0].ACTION==="select_all"){
                                                if(messageQuerys[0].VERTX_MESSAGE ==="No querys for this work")
                                                {
                                                     //NO HAY QUERYS
                                                    $scope.HaveQuerys = false;                                                         
                                                    $scope.info = messageQuerys[0].VERTX_MESSAGE;
                                                }  
                                                else{
                                                    //SI HAY QUERYS
                                                    $scope.info = "";
                                                    $scope.HaveQuerys = true;         
                                                    $scope.generateTable(messageQuerys);
                                                   // $scope.$broadcast('SnapshotsResults', {SnapshotsResults: messageSnapshots}); 
                                                }
                                     }

                                };

                                if(messageQuerys[0].detailed==="yes"  && messageQuerys[0].ID_SES===sessionStorage.idSesion && messageQuerys[0].ID_CON===(actionData.getIdCon()).toString()){
                                        if(messageQuerys[0].ACTION==="select_detail"){
                                              $scope.DetailedQuery = messageQuerys[1];
                                              //console.log("detailedquery:" + JSON.stringify(messageQuerys));
                                        }

                                        if(messageQuerys[0].ACTION==="select_bg_detail"){
                                        
                                              $scope.BGDetailResult = messageQuerys;
                                              $scope.BGDetailResult.shift();
                                           //   $scope.generateTable($scope.BGDetailResult);
                                        }                                        
                                        
                                        
                                };
                                
                                
                            });         
                            
                               //BUS oracle_capture_results
                            vertxEventBusService.on('oracle_capture_results', function(messageOracleCapture) {
                                console.log("oracle_capture_results:"+JSON.stringify(messageOracleCapture));
                               console.log("el tipo de datos de messageOracleCapture es " + Object.prototype.toString.call(messageOracleCapture)); 
                               
                               if(Object.prototype.toString.call(messageOracleCapture) === "[object Array]"){
                                   console.log("es un object array");
                                   if(messageOracleCapture[0].VERTX_ERROR === "NO" && messageOracleCapture[0].ACTION==="test_oracle_conn" && messageOracleCapture[0].ID_SES===sessionStorage.idSesion && messageOracleCapture[0].ID_CON===(actionData.getIdCon()).toString()){
                                        $scope.errorCapture = messageOracleCapture[0].VERTX_MESSAGE;
                                        $scope.connectionOK = true;
                                        sessionStorage.connectionOK = true;
                                        console.log("NO hay error en messageOracleCapture en el test_oracle_conn");
                                        
                                       // {ID_SES:sessionStorage.idSesion, ID_CON: (actionData.setIdCon()).toString(),VERTX_ACTION:"test_oracle_conn",HOST_NAME:sessionStorage.AWRhostname,PORT:sessionStorage.AWRport,DB_NAME:sessionStorage.AWRdbname,USER_NAME:sessionStorage.AWRusername,PASSWD:sessionStorage.AWRpassword,ORACLE_SERVICE_SID:sessionStorage.AWRservice}
                                       // console.log({ID_SES:sessionStorage.idSesion, ID_CON: (actionData.setIdCon()).toString(), VERTX_ACTION:"select_all_AWR",DB_TYPE:"Oracle",HOST_NAME:sessionStorage.AWRhostname,PORT:sessionStorage.AWRport,DB_NAME:sessionStorage.AWRdbname,USER_NAME:sessionStorage.AWRusername,PASSWD:sessionStorage.AWRpassword});
                                        vertxEventBusService.send('oracle_capture_actions', {ID_SES:sessionStorage.idSesion, ID_CON: (actionData.setIdCon()).toString(), VERTX_ACTION:"select_all_AWR",DB_TYPE:"Oracle",HOST_NAME:sessionStorage.AWRhostname,PORT:sessionStorage.AWRport,DB_NAME:sessionStorage.AWRdbname,USER_NAME:sessionStorage.AWRusername,PASSWD:sessionStorage.AWRpassword,ORACLE_SERVICE_SID:sessionStorage.AWRservice}); 
                                    }
                                    if(messageOracleCapture[0].VERTX_ERROR === "NO" && messageOracleCapture[0].ACTION==="select_all_AWR" && messageOracleCapture[0].ID_SES===sessionStorage.idSesion && messageOracleCapture[0].ID_CON===(actionData.getIdCon()).toString()){
                                        $scope.errorCapture = messageOracleCapture[0].VERTX_MESSAGE;
                                        $scope.connectionOK = true;
                                        console.log("NO hay error en messageOracleCapture en el select_all_AWR");
                                      //  $scope.allAWR = messageOracleCapture;
                                        //$scope.allAWR.shift();
                                        $scope.generateTable(messageOracleCapture);    
                                       // {ID_SES:sessionStorage.idSesion, ID_CON: (actionData.setIdCon()).toString(),VERTX_ACTION:"test_oracle_conn",HOST_NAME:sessionStorage.AWRhostname,PORT:sessionStorage.AWRport,DB_NAME:sessionStorage.AWRdbname,USER_NAME:sessionStorage.AWRusername,PASSWD:sessionStorage.AWRpassword,ORACLE_SERVICE_SID:sessionStorage.AWRservice}
                                       // console.log({ID_SES:sessionStorage.idSesion, ID_CON: (actionData.setIdCon()).toString(), VERTX_ACTION:"select_all_AWR",DB_TYPE:"Oracle",HOST_NAME:sessionStorage.AWRhostname,PORT:sessionStorage.AWRport,DB_NAME:sessionStorage.AWRdbname,USER_NAME:sessionStorage.AWRusername,PASSWD:sessionStorage.AWRpassword});
                                      //  vertxEventBusService.send('oracle_capture_actions', {ID_SES:sessionStorage.idSesion, ID_CON: (actionData.setIdCon()).toString(), VERTX_ACTION:"select_all_AWR",DB_TYPE:"Oracle",HOST_NAME:sessionStorage.AWRhostname,PORT:sessionStorage.AWRport,DB_NAME:sessionStorage.AWRdbname,USER_NAME:sessionStorage.AWRusername,PASSWD:sessionStorage.AWRpassword,ORACLE_SERVICE_SID:sessionStorage.AWRservice}); 
                                    }
                               }
                               if(Object.prototype.toString.call(messageOracleCapture) === "[object Object]"){
                                   console.log("es un object object");
                                    if(messageOracleCapture.VERTX_ERROR && messageOracleCapture.ID_SES===sessionStorage.idSesion && messageOracleCapture.ID_CON===(actionData.getIdCon()).toString()){
                                        $scope.errorCapture = messageOracleCapture.VERTX_ERROR;
                                        $scope.connectionOK = false;
                                        console.log("SI hay error en messageOracleCapture");
                                    }
                               }
                                
                            });         
    
    //REFRESH PAGE
     $scope.refreshPage = function(){
       //  alert("llama a refreshpage");
                   //       if(sessionStorage.idSesion){
                             //ENVIA LA PETICION PARA OBTENER TODOS LOS WORKS
                             vertxEventBusService.send('work_actions', {VERTX_ACTION: "select_all", ID_SES:sessionStorage.idSesion, ID_CON:  (actionData.setIdCon()).toString()});
                     //    }
         
             $scope.info="Connecting with server...";
             $scope.HaveResults = false;
             switch($location.path()){
                 case "/home":
                 $scope.page = "Home";
                 $scope.helpText="Texto de ayuda de la pagina principal";
                 break;
                 
                 case "/works":
                 $scope.page = "Works";
                 $scope.helpText="Texto de ayuda de la pagina Works";
                 break;
                 
                 case "/works/"+ $stateParams.SelectedWorkName:
                 $scope.page = "Works Details";
                 $scope.helpText="Texto de ayuda de la pagina Works Details";
                 break;
                 
                 case "/works/"+ $stateParams.SelectedWorkName +"/Snapshots":
                 $scope.page = "Snapshots";
                 $scope.helpText="Texto de ayuda de la pagina Snapshots";
                 break;
                 
                 case "/works/"+ $stateParams.SelectedWorkName +"/Snapshots/details/"+ $stateParams.idSnapshot:
                 $scope.page = "Snapshots Details";
                 $scope.helpText="Texto de ayuda de la pagina Snapshots Details";
                 break;   
             
                 case "/works/"+ $stateParams.SelectedWorkName +"/Querys":
                 $scope.page = "Querys";
                 $scope.helpText="Texto de ayuda de la pagina Querys";
                 break;
                 
                 case "/works/Reports":
                 $scope.page = "Reports";
                 $scope.helpText="Texto de ayuda de la pagina Reports";
                 break;
                 
                 case "/works/"+ $stateParams.SelectedWorkName +"/Querys/details/" + $stateParams.idQuery:
                 $scope.page = "Query Details";
                 $scope.helpText="Query details idquery " + $stateParams.idQuery;
                 break;
                 
                 case "/works/"+ $stateParams.SelectedWorkName +"/Snapshots/details/"+ $stateParams.idSnapshot +"/Parameters":
                 $scope.page = "Snapshots Parameters";
                 $scope.helpText="Texto de ayuda de la pagina Snapshots Parameters";
                 break; 
                 
                 case "/works/"+ $stateParams.SelectedWorkName +"/Snapshots/details/"+ $stateParams.idSnapshot +"/Execution":
                 $scope.page = "Snapshots Execution";
                 $scope.helpText="Texto de ayuda de la pagina Snapshots Execution";
                 break;
                 
                 case "/works/"+ $stateParams.SelectedWorkName +"/capture":
                 $scope.page = "Capture";
                 $scope.helpText="Texto de ayuda de la pagina Capture";
                 break;
                 
                 case "/works/"+ $stateParams.SelectedWorkName +"/capture/awr":
                 $scope.page = "Capture AWR";
                 $scope.helpText="Texto de ayuda de la pagina Capture AWR";
                 break;
  
                 case "/works/"+ $stateParams.SelectedWorkName +"/capture/memory":
                 $scope.page = "Capture MEMORY";
                 $scope.helpText="Texto de ayuda de la pagina Capture MEMORY";
                 break;   

                 case "/works/"+ $stateParams.SelectedWorkName +"/capture/sts":
                 $scope.page = "Capture STS";
                 $scope.helpText="Texto de ayuda de la pagina Capture STS";
                 break;   
             
                 case "/works/"+ $stateParams.SelectedWorkName +"/capture/gpsql":
                 $scope.page = "Capture GPSQL";
                 $scope.helpText="Texto de ayuda de la pagina Capture GPSQL";
                 break;                   
             }
        };

           
         
           
 }; //acaba el init
  
    window.onload = init;

$scope.generateTable=function(datos){
    //vertxEventBusService.send('work_actions', {VERTX_ACTION: "select_all", ID_SES:sessionStorage.idSesion, ID_CON:  (actionData.setIdCon()).toString()});
                       
                         
                        $scope.sort = function(keyname){
                            $scope.updown = false; 
                            $scope.sortKey = keyname;   //set the sortKey to the param passed
                            $scope.reverse = !$scope.reverse; //if true make it false and vice versa
                            
                        };
                        
                        $scope.Results = datos;
                       // $scope.itemsPerPage = 10;
                        $scope.HaveResults = true;
            switch($scope.page){
                 case "Home":
                     $scope.Works = datos;
                     $scope.Works.shift();
                     $scope.WorksPage = false;
                     console.log("$scope.Works: "+$scope.Works.length);
                     $scope.sortKey = "ID_WORK"; 
                     $scope.currentPageWorks=1;
                     $scope.itemsPerPageWorks=5;
                     $scope.totalWorks=$scope.Works.length;
                     $scope.currentPage=1;
                     $scope.itemsPerPage=$scope.itemsPerPageWorks;
                     $scope.total=$scope.totalWorks;
                     sessionStorage.currentPageWorks=1;
                 break;
                 
                 case "Works":
                     $scope.Works = datos;
                     $scope.Works.shift();
                     $scope.sortKey = "ID_WORK"; 
                    //$scope.currentPageWorks=1;
                     $scope.itemsPerPageWorks=10;
                     $scope.totalWorks=$scope.Works.length;
                     $scope.currentPage=sessionStorage.currentPageWorks;
                     $scope.itemsPerPage=$scope.itemsPerPageWorks;
                     $scope.total=$scope.totalWorks;
                 break;
                
                 case "Snapshots":
                     $scope.SnapshotsResults = datos;
                     $scope.SnapshotsResults.shift(); 
                     $scope.sortKey = "ID_SNAPSHOT";   
                     $scope.currentPageSnap=1;
                     $scope.itemsPerPageSnap=10;
                     $scope.totalSnap=$scope.SnapshotsResults.length;
                     $scope.currentPage=sessionStorage.currentPageSnapshots;
                     $scope.itemsPerPage=$scope.itemsPerPageSnap;
                     $scope.total=$scope.totalSnap;                     
                 break;
                      
                 case "Querys":
                     $scope.QueryResults = datos;
                     $scope.QueryResults.shift(); 
                     $scope.sortKey = "ID_QUERY"; 
                     $scope.currentPageQuerys=1;
                     $scope.itemsPerPageQuerys=10;
                     $scope.totalQuerys=$scope.QueryResults.length;
                     $scope.currentPage=sessionStorage.currentPageQuerys;
                     $scope.itemsPerPage=$scope.itemsPerPageQuerys;
                     $scope.total=$scope.totalQuerys;
                 break;
                 
                 case "Query Details":
                     $scope.QueryResultsDetails = datos;
                     $scope.sortKey = "ID_QUERY"; 
                     $scope.currentPageQuerysDetails=1;
                     $scope.itemsPerPageQuerysDetails=10;
                     $scope.totalQuerysDetails=$scope.QueryResultsDetails.length;
                     $scope.currentPage=sessionStorage.currentPageQuerysDetails;
                     $scope.itemsPerPage=$scope.itemsPerPageQuerysDetails;
                     $scope.total=$scope.totalQuerysDetails;
                 break;
                 
                 case "Snapshots Details":
                     $scope.ExecutionResults = datos;
                     $scope.ExecutionResults.shift(); 
                     $scope.sortKey = "ID_SNAPSHOT";   
                     $scope.currentPageExecution=1;
                     $scope.itemsPerPageExecution=10;
                     $scope.totalExecution=$scope.ExecutionResults.length;
                     $scope.currentPage=sessionStorage.currentPageExecution;
                     $scope.itemsPerPage=$scope.itemsPerPageExecution;
                     $scope.total=$scope.totalExecution;    
                 break;
                 
                 case "Snapshots Parameters":
                     $scope.ParametersResults = datos;
                     $scope.ParametersResults.shift(); 
                     $scope.sortKey = "ID_SNAPSHOT";   
                     $scope.currentPageParameters=1;
                     $scope.itemsPerPageParameters=10;
                     $scope.totalParameters=$scope.ParametersResults.length;
                     $scope.currentPage=sessionStorage.currentPageParameters;
                     $scope.itemsPerPage=$scope.itemsPerPageParameters;
                     $scope.total=$scope.totalParameters;
                 break; 
                 
                 case "Snapshots Execution":
                     $scope.ExecutionResults = datos;
                     $scope.ExecutionResults.shift(); 
                     $scope.sortKey = "ID_SNAPSHOT";   
                     $scope.currentPageExecution=1;
                     $scope.itemsPerPageExecution=10;
                     $scope.totalExecution=$scope.ExecutionResults.length;
                     $scope.currentPage=sessionStorage.currentPageExecution;
                     $scope.itemsPerPage=$scope.itemsPerPageExecution;
                     $scope.total=$scope.totalExecution;    
                 break;
                 
                 case "Capture AWR":
                     //alert("entra en capture awr en generatetable");
                     $scope.allAWR = datos;
                    
                     $scope.allAWR.shift(); 
                   //   alert(JSON.stringify($scope.allAWR));
                     $scope.sortKey = "BDID"; 
                     $scope.currentPageAllAWR=1;
                     $scope.itemsPerPageAllAWR=10;
                     $scope.totalAllAWR=$scope.allAWR.length;
                     $scope.currentPage=sessionStorage.currentPageAllAWR;
                     $scope.itemsPerPage=$scope.itemsPerPageAllAWR;
                     $scope.total=$scope.totalAllAWR;
                 break;
                  
                 default:
                     $scope.currentPage=1;
                     $scope.itemsPerPage=10;
                     $scope.total=$scope.Results.length;
             }
                       /* if($scope.page==="Home"){
                            $scope.Works = datos;
                            console.log("$scope.Works: "+$scope.Works.length);
                            $scope.sortKey = "ID_WORK"; 
                            $scope.currentPageWorks=1;
                            $scope.itemsPerPageWorks=5;
                            $scope.totalWorks=$scope.Works.length;
                            $scope.currentPage=1;
                            $scope.itemsPerPage=$scope.itemsPerPageWorks;
                            $scope.total=$scope.totalWorks;  
                        }else if($scope.page === "Works"){
                            $scope.Works = datos;
                            $scope.sortKey = "ID_WORK"; 
                            $scope.currentPageWorks=1;
                            $scope.itemsPerPageWorks=10;
                            $scope.totalWorks=$scope.Works.length;
                            $scope.currentPage=sessionStorage.currentPageWorks;
                            $scope.itemsPerPage=$scope.itemsPerPageWorks;
                            $scope.total=$scope.totalWorks;
                        }else if($scope.page === "Querys"){
                            $scope.QueryResults = datos;
                            $scope.QueryResults.shift(); 
                            $scope.sortKey = "ID_QUERY"; 
                            $scope.currentPageQuerys=1;
                            $scope.itemsPerPageQuerys=10;
                            $scope.totalQuerys=$scope.QueryResults.length;
                            $scope.currentPage=sessionStorage.currentPageQuerys;
                            $scope.itemsPerPage=$scope.itemsPerPageQuerys;
                            $scope.total=$scope.totalQuerys;
                        }else if($scope.page === "Query Details"){
                            $scope.QueryResultsDetails = datos;
                            $scope.sortKey = "ID_QUERY"; 
                            $scope.currentPageQuerysDetails=1;
                            $scope.itemsPerPageQuerysDetails=10;
                            $scope.totalQuerysDetails=$scope.QueryResultsDetails.length;
                            $scope.currentPage=sessionStorage.currentPageQuerysDetails;
                            $scope.itemsPerPage=$scope.itemsPerPageQuerysDetails;
                            $scope.total=$scope.totalQuerysDetails;
                        }else if($scope.page === "Snapshots"){
                            $scope.SnapshotsResults = datos;
                            $scope.SnapshotsResults.shift(); 
                            $scope.sortKey = "ID_SNAPSHOT";   
                            $scope.currentPageSnap=1;
                            $scope.itemsPerPageSnap=10;
                            $scope.totalSnap=$scope.SnapshotsResults.length;
                            $scope.currentPage=sessionStorage.currentPageSnapshots;
                            $scope.itemsPerPage=$scope.itemsPerPageSnap;
                            $scope.total=$scope.totalSnap;
                        }else if($scope.page === "Snapshots Details"){
                            $scope.DetailedSnapshot = datos;
                            $scope.DetailedSnapshot.shift();
                            $scope.total=$scope.Results.lenght;
                            $scope.sortKey = "STATS_ELAPSED_TIME";   
                        }else if($scope.page === "Snapshots Parameters"){
                            $scope.ParametersResults = datos;
                            $scope.ParametersResults.shift(); 
                            $scope.sortKey = "ID_SNAPSHOT";   
                            $scope.currentPageParameters=1;
                            $scope.itemsPerPageParameters=10;
                            $scope.totalParameters=$scope.ParametersResults.length;
                            $scope.currentPage=sessionStorage.currentPageParameters;
                            $scope.itemsPerPage=$scope.itemsPerPageParameters;
                            $scope.total=$scope.totalParameters;
                        }else if($scope.page === "Snapshots Execution"){
                            $scope.ExecutionResults = datos;
                            $scope.ExecutionResults.shift(); 
                            $scope.sortKey = "ID_SNAPSHOT";   
                            $scope.currentPageExecution=1;
                            $scope.itemsPerPageExecution=10;
                            $scope.totalExecution=$scope.ExecutionResults.length;
                            $scope.currentPage=sessionStorage.currentPageExecution;
                            $scope.itemsPerPage=$scope.itemsPerPageExecution;
                            $scope.total=$scope.totalExecution;
                        }else{
                            $scope.currentPage=1;
                            $scope.itemsPerPage=10;
                            $scope.total=$scope.Results.length;
                        }  */   
                             
                        $scope.numvalues = [3,5,10,20,50];  
                        
                        $scope.maxRange = ($scope.currentPage * $scope.itemsPerPage);
                        $scope.minRange = ($scope.maxRange-$scope.itemsPerPage)+1;
                        if($scope.total < $scope.maxRange){
                                $scope.maxRange = $scope.total;
                        }
                            
                        $scope.refreshItemsPerPage = function(new_value){
                            $scope.itemsPerPage = new_value;
                           // $scope.currentPage = 1;
                        };
                             
                          $scope.setRange= function(currentPage){
                            $scope.currentPage = currentPage;
                                if($scope.page==="Home"){
                                    sessionStorage.currentPageHome=$scope.currentPage;
                                }else if($scope.page === "Works"){
                                    sessionStorage.currentPageWorks=$scope.currentPage;
                                }else if($scope.page==="Querys"){
                                    sessionStorage.currentPageQuerys=$scope.currentPage;
                                }else if($scope.page === "Query Details"){
                                    sessionStorage.currentPageQuerysDetails=$scope.currentPage;
                                }else if($scope.page==="Snapshots"){
                                    sessionStorage.currentPageSnapshots=$scope.currentPage;
                                }else if($scope.page === "Snapshots Parameters"){
                                    sessionStorage.currentPageParameters=$scope.currentPage;
                                }else if($scope.page === "Snapshots Execution"){
                                    sessionStorage.currentPageExecution=$scope.currentPage;
                                }else if($scope.page === "Capture AWR"){
                                    sessionStorage.currentPageAllAWR=$scope.currentPage;
                                }
                            
                           // sessionStorage.currentPage = $scope.currentPage;
                            $scope.maxRange = ($scope.currentPage * $scope.itemsPerPage);
                            $scope.minRange = ($scope.maxRange-$scope.itemsPerPage)+1;
                            if($scope.total < $scope.maxRange){
                                $scope.maxRange = $scope.total;
                            }
                        };   
    }; 

         

      $scope.SeeDetails = function(SelectedWork) {
        $scope.SelectedIdWork = SelectedWork.ID_WORK;
        $scope.SelectedWorkName = SelectedWork.WORK_NAME;
        $scope.SelectedWorkCreated = SelectedWork.CREATED;
        if($scope.pages < $scope.currentPage){
            $scope.currentPage = $scope.pages;
            console.log($scope.currentPage);
         }
        sessionStorage.SelectedIdWork = $scope.SelectedIdWork;
        sessionStorage.SelectedWorkName = $scope.SelectedWorkName;
        sessionStorage.SelectedWorkCreated = $scope.SelectedWorkCreated;
        //sessionStorage.currentPage = 1;
        sessionStorage.currentPageHome=1;
        if($scope.page==="Works" || $scope.page==="Works Details"){
            console.log("sessionStorage.currentPageWorks: reseteando");
            sessionStorage.currentPageWorks=1;
        }
//        else{
//            console.log("la pagina es works o works details en seedetails");
//           // sessionStorage.currentPageWorks = sessionStorage.currentPageWorks;
//        }
        sessionStorage.currentPageSnapshots=1;
        sessionStorage.currentPageQuerys=1;
        sessionStorage.currentPageQuerysDetails=1;
        sessionStorage.currentPageParameters=1;
        sessionStorage.currentPageExecution=1;
        sessionStorage.currentPageAllAWR=1;
         
     };
               
      //CONTROLA SI SE PUEDE O NO TENER VARIOS ACORDEONES ABIERTOS            
      $scope.oneAtATime = false;
//JSON DE PRUEBA PARA LA PAGINA DE REPORTS
      $scope.Snapshots = [
        {
          title: 'Snapshot 1',
          templateUrl: '/templates/SnapshotsDetailsTemplate.html'
        },
        {
          title: 'Snapshot 2',
          templateUrl: 'templates/SnapshotsDetailsTemplate.html'     
        }
      ];
   //FUNCION PARA VOLVER A LA ULTIMA PAGINA VISTA         
    $scope.volver = function()
                {
                    window.history.go(-1);
                };

//COMPRUEBA CADA SEGUNDO SI ESTÁ LOGADO
     $interval(function(){
        
        // $scope.logado = sessionStorage.logado;
         
           
        if(sessionStorage.logado)
        {
            $scope.changeClass();
            $scope.user = sessionStorage.user;
            $scope.no_logado = false;
            $scope.url=$location.url();
        }

      },100);
   
    //LOGIN             
$scope.login = function(){

   var userVal = document.getElementById('user').value;
    var passwordVal = document.getElementById('password').value;
   // var repoVal = document.getElementById('selectedRepo').value;
       
    if (vacio(userVal) === false) {
        $scope.errorLogin = "Please, fill the user";
    }
    else if (vacio(passwordVal) === false) {
        $scope.errorLogin = "Please, fill the password";
    }
    else{
        $scope.infoLogin="Connecting with server...";
        $scope.errorLogin = "";
        $scope.logado=true;
        sessionStorage.logado = $scope.logado;
        sessionStorage.user = userVal;
        //sessionStorage.repo = repoVal;
        sessionStorage.idSesion = uniqueID();
        $scope.user = sessionStorage.user;
        $scope.repositorio = sessionStorage.repoName;
        $scope.idSesion = sessionStorage.idSesion;
        $scope.infoLogin="";
        $state.go("Home",{});
       
        vertxEventBusService.send('work_actions', {VERTX_ACTION: "select_all", ID_SES:sessionStorage.idSesion, ID_CON:  actionData.setIdCon().toString()});
    }
    console.log("logado: "+$scope.logado);
    $scope.changeClass();
};

                        
$scope.logout = function(){
    $scope.logado=false;
   $state.go("Login",{});
    $scope.changeClass();
};


//ACABA EL CONTROLADOR DE ANGULAR
});
